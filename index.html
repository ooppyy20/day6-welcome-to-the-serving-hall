<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì›°ì»´ íˆ¬ ë” ì„œë¹™í™€ - Refactored</title>
    <style>
        :root {
            --bg-color: #f0e68c;
            --primary-color: #ff6b6b;
            --success-color: #2ed573;
            --fever-color: #ffd700;
            --warning-color: #f44336;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', -apple-system, sans-serif;
            background-color: var(--bg-color);
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* HUD */
        #hud {
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        /* Timer Bar */
        #timerBarContainer {
            width: 100%;
            height: 10px;
            background: #ddd;
        }

        #timerBar {
            width: 100%;
            height: 100%;
            background: var(--success-color);
            transition: width 0.1s linear;
        }

        #timerBar.warning {
            background: var(--warning-color);
            animation: flash 0.5s infinite;
        }

        /* Game Board */
        #board {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .table-area {
            width: 35%;
            height: 70%;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            border: 4px dashed #999;
            transition: all 0.2s;
        }

        .animal-slot {
            font-size: 50px;
            position: relative;
            transition: transform 0.2s;
        }

        .food-hint {
            font-size: 20px;
            position: absolute;
            bottom: -10px;
            right: -10px;
        }

        /* Center Queue */
        #servingBelt {
            width: 25%;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 15px;
        }

        .food-item {
            font-size: 40px;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 5px rgba(0, 0, 0, 0.2);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .food-item.next {
            border: 4px solid var(--primary-color);
            transform: scale(1.2);
        }

        /* Overlay */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
        }

        button {
            padding: 15px 40px;
            font-size: 24px;
            border: none;
            border-radius: 30px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Animations */
        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes flash {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes floatUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        @keyframes heartUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-100px) scale(1.5);
                opacity: 0;
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .fever-mode {
            background-color: var(--fever-color) !important;
            transition: background 0.3s;
        }

        .floating-text {
            position: absolute;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
        }

        .heart-fx {
            position: absolute;
            font-size: 30px;
            pointer-events: none;
            animation: heartUp 0.8s ease-out forwards;
            z-index: 50;
        }

        .shake-fx {
            animation: shake 0.3s ease-in-out;
            border-color: var(--primary-color) !important;
            background: rgba(255, 107, 107, 0.2) !important;
        }

        .success-fx {
            border-color: var(--success-color) !important;
            background: rgba(46, 213, 115, 0.2) !important;
        }
    </style>
</head>

<body>

    <div id="gameContainer">
        <div id="hud">
            <div class="stat-item"><span class="stat-label">SCORE</span><span id="scoreValue"
                    class="stat-value">0</span></div>
            <div class="stat-item"><span class="stat-label">COMBO</span><span id="comboValue"
                    class="stat-value">0</span></div>
            <div class="stat-item"><span class="stat-label">TIME</span><span id="timeValue"
                    class="stat-value">60.0</span></div>
        </div>
        <div id="timerBarContainer">
            <div id="timerBar"></div>
        </div>

        <div id="board">
            <div id="leftTable" class="table-area" onclick="handleServe('left')"></div>
            <div id="servingBelt"></div>
            <div id="rightTable" class="table-area" onclick="handleServe('right')"></div>
        </div>

        <div id="startOverlay" class="overlay">
            <h1>ğŸ» ì›°ì»´ íˆ¬ ë” ì„œë¹™í™€ ğŸ¦Š</h1>
            <p>ìŒì‹ì„ ì„ í˜¸í•˜ëŠ” ë™ë¬¼ì´ ìˆëŠ” ë°©í–¥ìœ¼ë¡œ í„°ì¹˜í•˜ì„¸ìš”!</p>
            <button onclick="startGame()">ì˜ì—… ì‹œì‘</button>
        </div>

        <div id="gameOverOverlay" class="overlay" style="display: none;">
            <h1>ì˜ì—… ì¢…ë£Œ!</h1>
            <p>ìµœì¢… ì ìˆ˜: <span id="finalScore">0</span></p>

            <div id="recordSection">
                <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="10"
                    style="padding:10px; border-radius:5px;">
                <button onclick="submitScore()">ì ìˆ˜ ë“±ë¡</button>
            </div>

            <div id="leaderboard"
                style="margin-top:20px; font-size:14px; background:rgba(255,255,255,0.1); padding:10px; border-radius:10px;">
                <h3>ì˜¤ëŠ˜ì˜ ê³ ë“ì ì</h3>
                <div id="leaderboardList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <button onclick="startGame()">ë‹¤ì‹œ ì˜¤í”ˆí•˜ê¸°</button>
        </div>
    </div>

    <script>
        /**
         * GAME CONFIGURATION & CONSTANTS
         */
        const GAME_DATA = {
            animals: [
                { id: 'bear', emoji: 'ğŸ»', food: 'ğŸ²' },
                { id: 'fox', emoji: 'ğŸ¦Š', food: 'â˜•' },
                { id: 'rabbit', emoji: 'ğŸ°', food: 'ğŸ¥£' },
                { id: 'dog', emoji: 'ğŸ¶', food: 'ğŸ§ƒ' }
            ],
            timeLimit: 30,
            timePenalty: 2,
            timeBonus: 0.2,
            feverThreshold: 10,
            feverDuration: 50, // 5ì´ˆ (0.1ì´ˆ ë‹¨ìœ„)
            feverProbability: 0.8,
            maxQueueSize: 6,
            difficultyThresholds: [
                { score: 2000, totalAnimals: 2 },
                { score: 5000, totalAnimals: 3 }
            ]
        };

        /**
         * GAME STATE
         */
        let gameState = {
            score: 0,
            combo: 0,
            timeLeft: 0,
            isActive: false,
            isFever: false,
            feverTimer: 0,
            feverFoodItem: null,
            tables: { left: [], right: [] },
            foodQueue: [],
            timerInterval: null
        };

        const dom = {
            score: document.getElementById('scoreValue'),
            combo: document.getElementById('comboValue'),
            time: document.getElementById('timeValue'),
            timerBar: document.getElementById('timerBar'),
            leftTable: document.getElementById('leftTable'),
            rightTable: document.getElementById('rightTable'),
            belt: document.getElementById('servingBelt'),
            startOverlay: document.getElementById('startOverlay'),
            gameOverOverlay: document.getElementById('gameOverOverlay'),
            finalScore: document.getElementById('finalScore'),
            container: document.getElementById('gameContainer')
        };

        /**
         * UTILS
         */
        const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const createAnimalHTML = (animal) => `
        <div class="animal-slot">
            ${animal.emoji}<span class="food-hint">${animal.food}</span>
        </div>`;

        /**
         * CORE GAME ENGINE
         */
        function startGame() {
            // Reset State
            gameState = {
                ...gameState,
                score: 0,
                combo: 0,
                timeLeft: GAME_DATA.timeLimit,
                isActive: true,
                isFever: false,
                tables: { left: [], right: [] },
                foodQueue: []
            };

            dom.startOverlay.style.display = 'none';
            dom.gameOverOverlay.style.display = 'none';
            dom.container.classList.remove('fever-mode');

            setupInitialAnimals();
            fillQueue();
            updateUI();

            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            gameState.timerInterval = setInterval(updateTick, 100);
        }

        function setupInitialAnimals() {
            const shuffled = [...GAME_DATA.animals].sort(() => Math.random() - 0.5);
            gameState.tables.left.push(shuffled[0]);
            gameState.tables.right.push(shuffled[1]);
            renderTables();
        }

        function renderTables() {
            dom.leftTable.innerHTML = gameState.tables.left.map(createAnimalHTML).join('');
            dom.rightTable.innerHTML = gameState.tables.right.map(createAnimalHTML).join('');
        }

        function fillQueue() {
            const currentFoods = [...gameState.tables.left, ...gameState.tables.right].map(a => a.food);

            while (gameState.foodQueue.length < GAME_DATA.maxQueueSize) {
                if (gameState.isFever) {
                    if (!gameState.feverFoodItem) gameState.feverFoodItem = getRandomItem(currentFoods);
                    const food = Math.random() < GAME_DATA.feverProbability ? gameState.feverFoodItem : getRandomItem(currentFoods);
                    gameState.foodQueue.push(food);
                } else {
                    gameState.foodQueue.push(getRandomItem(currentFoods));
                }
            }
            renderQueue();
        }

        function renderQueue() {
            dom.belt.innerHTML = gameState.foodQueue.map((food, idx) =>
                `<div class="food-item ${idx === 0 ? 'next' : ''}">${food}</div>`
            ).join('');
        }

        function handleServe(side) {
            if (!gameState.isActive) return;

            const servedFood = gameState.foodQueue[0];
            const targetTableData = gameState.tables[side];
            const targetTableDOM = side === 'left' ? dom.leftTable : dom.rightTable;

            const animalIndex = targetTableData.findIndex(animal => animal.food === servedFood);
            const isCorrect = animalIndex !== -1;

            if (isCorrect) {
                handleSuccess(targetTableDOM, animalIndex);
            } else {
                handleFailure(targetTableDOM);
            }

            gameState.foodQueue.shift();
            checkDifficulty();
            fillQueue();
            updateUI();
        }

        function handleSuccess(tableDOM, animalIdx) {
            gameState.combo++;
            const comboBonus = Math.floor(gameState.combo / 5) * 20;
            gameState.score += (100 + comboBonus);
            gameState.timeLeft = Math.min(GAME_DATA.timeLimit, gameState.timeLeft + GAME_DATA.timeBonus);

            tableDOM.classList.add('success-fx');
            setTimeout(() => tableDOM.classList.remove('success-fx'), 300);

            const animalSlot = tableDOM.querySelectorAll('.animal-slot')[animalIdx];
            if (animalSlot) triggerHeartEffect(animalSlot);

            if (gameState.combo >= GAME_DATA.feverThreshold && !gameState.isFever) {
                startFever();
            }
        }

        function handleFailure(tableDOM) {
            gameState.combo = 0;
            gameState.score = Math.max(0, gameState.score - 50);
            gameState.timeLeft -= GAME_DATA.timePenalty;

            tableDOM.classList.add('shake-fx');
            setTimeout(() => tableDOM.classList.remove('shake-fx'), 300);

            showFloatingText(`-${GAME_DATA.timePenalty}s`, 'var(--warning-color)');
            if (gameState.isFever) endFever();
        }

        /**
         * EFFECTS
         */
        function triggerHeartEffect(parentEl) {
            const heart = document.createElement('div');
            heart.className = 'heart-fx';
            heart.innerText = 'â¤ï¸';
            heart.style.left = '20px';
            heart.style.top = '0px';
            parentEl.appendChild(heart);
            setTimeout(() => heart.remove(), 800);
        }

        function showFloatingText(text, color) {
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.innerText = text;
            el.style.color = color;
            el.style.left = '50%';
            el.style.top = '20%';
            dom.container.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        /**
         * SYSTEMS
         */
        function checkDifficulty() {
            const currentTotal = gameState.tables.left.length + gameState.tables.right.length;
            const threshold = GAME_DATA.difficultyThresholds.find(t => gameState.score > t.score && currentTotal === t.totalAnimals);

            if (threshold) {
                const usedIds = [...gameState.tables.left, ...gameState.tables.right].map(a => a.id);
                const nextAnimal = GAME_DATA.animals.find(a => !usedIds.includes(a.id));

                if (nextAnimal) {
                    if (gameState.tables.left.length <= gameState.tables.right.length) {
                        gameState.tables.left.push(nextAnimal);
                    } else {
                        gameState.tables.right.push(nextAnimal);
                    }
                    renderTables();
                }
            }
        }

        function startFever() {
            gameState.isFever = true;
            gameState.feverTimer = GAME_DATA.feverDuration;

            const allCurrentFoods = [...gameState.tables.left, ...gameState.tables.right].map(a => a.food);
            gameState.feverFoodItem = getRandomItem(allCurrentFoods);

            gameState.foodQueue = [];
            fillQueue();

            dom.container.classList.add('fever-mode');
            showFloatingText("ğŸ”¥ FEVER TIME! ğŸ”¥", "orange");
        }

        function endFever() {
            gameState.isFever = false;
            dom.container.classList.remove('fever-mode');
            showFloatingText("FEVER END", "#666");
        }

        function updateTick() {
            if (!gameState.isActive) return;

            gameState.timeLeft -= 0.1;
            if (gameState.isFever) {
                gameState.feverTimer--;
                if (gameState.feverTimer <= 0) endFever();
            }

            if (gameState.timeLeft <= 0) endGame();
            updateUI();
        }

        function updateUI() {
            dom.score.innerText = gameState.score;
            dom.combo.innerText = gameState.combo;
            dom.time.innerText = Math.max(0, gameState.timeLeft).toFixed(1);

            const timePercent = (gameState.timeLeft / GAME_DATA.timeLimit) * 100;
            dom.timerBar.style.width = `${timePercent}%`;
            dom.timerBar.classList.toggle('warning', timePercent < 30);
        }

        function endGame() {
            gameState.isActive = false;
            clearInterval(gameState.timerInterval);
            dom.finalScore.innerText = gameState.score;
            dom.gameOverOverlay.style.display = 'flex';
        }

        // Input Listeners
        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') handleServe('left');
            if (e.key === 'ArrowRight') handleServe('right');
        });

        // êµ¬ê¸€ ì„¤ë¬¸ì§€ ì •ë³´ (ë³¸ì¸ì˜ ê°’ìœ¼ë¡œ êµì²´ í•„ìš”)
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSedkgqcVKUXZbW64qAon3xzAnMDeECvHScQO4yEEEgWltlIIQ/formResponse";
        const ENTRY_NICKNAME = "entry.1963889324"; // ë‹‰ë„¤ì„ í•„ë“œ ID
        const ENTRY_SCORE = "entry.1300941228";    // ì ìˆ˜ í•„ë“œ ID
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTS1t7Q4XpK2ISwW7yuy2R4GzDVvY9PaHaOW-yOAodVixvfPn14MUdsUYyg6INGxz-n5dh68HpCqzvr/pub?output=csv";

        async function submitScore() {
            const nickname = document.getElementById('nickname').value;
            const score = gameState.score;

            if (!nickname) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!");

            // í¼ ë°ì´í„° ìƒì„± (CORS ì´ìŠˆë¥¼ í”¼í•˜ê¸° ìœ„í•´ mode: 'no-cors' ì‚¬ìš©)
            const formData = new URLSearchParams();
            formData.append(ENTRY_NICKNAME, nickname);
            formData.append(ENTRY_SCORE, score);

            try {
                await fetch(GOOGLE_FORM_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                alert("ë“±ë¡ ì™„ë£Œ!");
                document.getElementById('recordSection').style.display = 'none';
                loadLeaderboard(); // ë“±ë¡ í›„ ë¦¬ë”ë³´ë“œ ê°±ì‹ 
            } catch (e) {
                console.error("ë“±ë¡ ì‹¤íŒ¨", e);
            }
        }

async function loadLeaderboard() {
    const listEl = document.getElementById('leaderboardList');
    listEl.innerHTML = "ê¸°ë¡ í™•ì¸ ì¤‘...";

    try {
        const response = await fetch(SHEET_CSV_URL + "&cachebust=" + Date.now());
        const data = await response.text();

        // 1. í˜„ì¬ ë‚ ì§œ ì •ë³´ (ì˜¤ëŠ˜)
        const now = new Date();
        const curYear = now.getFullYear();
        const curMonth = now.getMonth() + 1;
        const curDate = now.getDate();

        // 2. CSV íŒŒì‹±
        const rows = data.split('\n').slice(1);
        const list = rows.map(row => {
            // ë”°ì˜´í‘œ ë° ê°œí–‰ë¬¸ì(\r) ì œê±° í›„ ë¶„ë¦¬
            const parts = row.replace(/["\r]/g, '').split(',');
            if (parts.length < 3) return null;

            const timeStr = parts[0].trim(); // "2026. 1. 9 ì˜¤í›„ 2:54:34"
            const nick = parts[1].trim();
            const sc = parseInt(parts[2].trim());

            if (!timeStr || isNaN(sc)) return null;

            // 3. ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ë‚ ì§œ ìˆ«ìë§Œ ì¶”ì¶œ (ë§¤ìš° ì¤‘ìš”!)
            // "2026. 1. 9 ..." -> [2026, 1, 9]
            const dateMatch = timeStr.match(/(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
            
            if (dateMatch) {
                const year = parseInt(dateMatch[1]);
                const month = parseInt(dateMatch[2]);
                const day = parseInt(dateMatch[3]);

                // ì˜¤ëŠ˜ ë‚ ì§œì™€ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ ë¹„êµ
                const isToday = (year === curYear && month === curMonth && day === curDate);
                if (isToday) return { nick, sc };
            }
            
            return null;
        })
        .filter(item => item !== null)
        .sort((a, b) => b.sc - a.sc)
        .slice(0, 20);

        // 4. í™”ë©´ ì¶œë ¥ (í…Œì´ë¸” í˜•íƒœ)
        if (list.length === 0) {
            listEl.innerHTML = "ì˜¤ëŠ˜ ë“±ë¡ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”! ğŸ†";
            return;
        }

        let html = `<div style="max-height: 250px; overflow-y: auto; padding-right: 5px;">
                      <table style="width: 100%; border-collapse: collapse; font-size: 14px;">`;
        
        list.forEach((item, idx) => {
            const isTop3 = idx < 3;
            const rowStyle = `border-bottom: 1px solid rgba(255,255,255,0.1);`;
            const rankStyle = isTop3 ? `color: var(--fever-color); font-weight: bold; font-size: 16px;` : `color: #ccc;`;
            
            html += `
                <tr style="${rowStyle}">
                    <td style="padding: 10px 5px; ${rankStyle}">${idx + 1}ìœ„</td>
                    <td style="padding: 10px 5px; text-align: left; font-weight: 500;">${item.nick}</td>
                    <td style="padding: 10px 5px; text-align: right; color: var(--fever-color); font-weight: bold;">
                        ${item.sc.toLocaleString()}
                    </td>
                </tr>`;
        });

        html += `</table></div>`;
        listEl.innerHTML = html;

    } catch (e) {
        console.error("ì˜¤ë¥˜ ìƒì„¸:", e);
        listEl.innerHTML = "ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
    }
}

        // ê²Œì„ ì¢…ë£Œ ì‹œ ë¦¬ë”ë³´ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤í–‰
        function endGame() {
            gameState.isActive = false;
            clearInterval(gameState.timerInterval);
            dom.finalScore.innerText = gameState.score;
            dom.gameOverOverlay.style.display = 'flex';
            document.getElementById('recordSection').style.display = 'block';
            loadLeaderboard();
        }
    </script>
</body>

</html>
