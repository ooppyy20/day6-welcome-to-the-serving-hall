<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì›°ì»´ íˆ¬ ë” ì„œë¹™í™€</title>
    <style>
        :root {
            --bg-color: #f0e68c;
            --primary-color: #ff6b6b;
            --success-color: #2ed573;
            --fever-color: #ffd700;
            --warning-color: #f44336;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Pretendard', -apple-system, sans-serif;
            background-color: var(--bg-color);
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #hud {
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        #timerBarContainer {
            width: 100%;
            height: 10px;
            background: #ddd;
        }

        #timerBar {
            width: 100%;
            height: 100%;
            background: var(--success-color);
            transition: width 0.1s linear;
        }

        #timerBar.warning {
            background: var(--warning-color);
            animation: flash 0.5s infinite;
        }

        #board {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .table-area {
            width: 35%;
            height: 70%;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            border: 4px dashed #999;
            transition: all 0.2s;
            cursor: pointer;
        }

        .animal-slot {
            font-size: 50px;
            position: relative;
            transition: transform 0.2s;
        }

        .food-hint {
            font-size: 20px;
            position: absolute;
            bottom: -10px;
            right: -10px;
        }

        #servingBelt {
            width: 25%;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 15px;
        }

        .food-item {
            font-size: 40px;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 5px rgba(0, 0, 0, 0.2);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .food-item.next {
            border: 4px solid var(--primary-color);
            transform: scale(1.2);
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            text-align: center;
        }

        button {
            padding: 15px 40px;
            font-size: 24px;
            border: none;
            border-radius: 30px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            margin-top: 20px;
        }

        /* FX & Animations */
        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes flash {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes floatUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        @keyframes heartUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-100px) scale(1.5);
                opacity: 0;
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .fever-mode {
            background-color: var(--fever-color) !important;
        }

        .floating-text {
            position: absolute;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
        }

        .heart-fx {
            position: absolute;
            font-size: 30px;
            pointer-events: none;
            animation: heartUp 0.8s ease-out forwards;
            z-index: 50;
        }

        .shake-fx {
            animation: shake 0.3s ease-in-out;
            border-color: var(--primary-color) !important;
            background: rgba(255, 107, 107, 0.2) !important;
        }

        .success-fx {
            border-color: var(--success-color) !important;
            background: rgba(46, 213, 115, 0.2) !important;
        }
    </style>
</head>

<body>

    <div id="gameContainer">
        <div id="hud">
            <div class="stat-item"><span class="stat-label">SCORE</span><span id="scoreValue"
                    class="stat-value">0</span></div>
            <div class="stat-item"><span class="stat-label">COMBO</span><span id="comboValue"
                    class="stat-value">0</span></div>
            <div class="stat-item"><span class="stat-label">TIME</span><span id="timeValue"
                    class="stat-value">0.0</span></div>
        </div>
        <div id="timerBarContainer">
            <div id="timerBar"></div>
        </div>

        <div id="board">
            <div id="leftTable" class="table-area"></div>
            <div id="servingBelt"></div>
            <div id="rightTable" class="table-area"></div>
        </div>

        <div id="startOverlay" class="overlay">
            <h1>ğŸ» ì›°ì»´ íˆ¬ ë” ì„œë¹™í™€ ğŸ¦Š</h1>
            <p>ìŒì‹ì„ ì„ í˜¸í•˜ëŠ” ë™ë¬¼ì´ ìˆëŠ” ë°©í–¥ìœ¼ë¡œ í„°ì¹˜í•˜ì„¸ìš”!</p>
            <button id="btnStart">ì˜ì—… ì‹œì‘</button>
        </div>

        <div id="gameOverOverlay" class="overlay" style="display: none;">
            <h1>ì˜ì—… ì¢…ë£Œ!</h1>
            <p>ìµœì¢… ì ìˆ˜: <span id="finalScore">0</span></p>
            <div id="recordSection">
                <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="10"
                    style="padding:10px; border-radius:5px;">
                <button id="btnSubmit">ì ìˆ˜ ë“±ë¡</button>
            </div>
            <div id="leaderboard"
                style="margin-top:20px; font-size:14px; background:rgba(255,255,255,0.1); padding:10px; border-radius:10px; width: 80%;">
                <h3>ì˜¤ëŠ˜ì˜ ê³ ë“ì ì</h3>
                <div id="leaderboardList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <button id="btnRestart">ë‹¤ì‹œ ì˜¤í”ˆí•˜ê¸°</button>
        </div>
    </div>

    <script>
        /**
         * 1. CONFIGURATION
         * ê²Œì„ì˜ ëª¨ë“  ë°¸ëŸ°ìŠ¤ ì¡°ì • ê°’ì„ í•œê³³ì— ëª¨ì•˜ìŠµë‹ˆë‹¤.
         */
        const CONFIG = {
            ANIMALS: [
                { id: 'bear', emoji: 'ğŸ»', food: 'ğŸ²' },
                { id: 'fox', emoji: 'ğŸ¦Š', food: 'â˜•' },
                { id: 'rabbit', emoji: 'ğŸ°', food: 'ğŸ¥£' },
                { id: 'dog', emoji: 'ğŸ¶', food: 'ğŸ§ƒ' }
            ],
            TIME: {
                LIMIT: 30,
                PENALTY: 2,
                BONUS: 0.2,
                TICK: 100 // ms
            },
            SCORING: {
                BASE: 100,
                COMBO_STEP: 5,
                COMBO_BONUS: 20,
                FAIL_PENALTY: 50
            },
            FEVER: {
                THRESHOLD: 10,
                DURATION: 50, // ticks (5sec)
                PROBABILITY: 0.8
            },
            DIFFICULTY: [
                { score: 2000, totalAnimals: 2 },
                { score: 5000, totalAnimals: 3 }
            ],
            MAX_QUEUE: 6,
            API: {
                FORM_URL: "https://docs.google.com/forms/d/e/1FAIpQLSedkgqcVKUXZbW64qAon3xzAnMDeECvHScQO4yEEEgWltlIIQ/formResponse",
                SHEET_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTS1t7Q4XpK2ISwW7yuy2R4GzDVvY9PaHaOW-yOAodVixvfPn14MUdsUYyg6INGxz-n5dh68HpCqzvr/pub?output=csv",
                ENTRY_NICK: "entry.1963889324",
                ENTRY_SCORE: "entry.1300941228"
            }
        };

        /**
         * 2. GAME STATE
         * í˜„ì¬ ì§„í–‰ì¤‘ì¸ ê²Œì„ì˜ ë°ì´í„°ë§Œ ê´€ë¦¬í•©ë‹ˆë‹¤.
         */
        class GameState {
            constructor() {
                this.reset();
            }
            reset() {
                this.score = 0;
                this.combo = 0;
                this.timeLeft = CONFIG.TIME.LIMIT;
                this.isActive = false;
                this.isFever = false;
                this.feverTimer = 0;
                this.feverFood = null;
                this.tables = { left: [], right: [] };
                this.foodQueue = [];
            }
        }

        /**
         * 3. GAME ENGINE
         * ê²Œì„ì˜ í•µì‹¬ ë¡œì§ê³¼ UI ì—…ë°ì´íŠ¸ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.
         */
        class ServingGame {
            constructor() {
                this.state = new GameState();
                this.initElements();
                this.bindEvents();
            }

            initElements() {
                this.el = {
                    container: document.getElementById('gameContainer'),
                    score: document.getElementById('scoreValue'),
                    combo: document.getElementById('comboValue'),
                    time: document.getElementById('timeValue'),
                    timerBar: document.getElementById('timerBar'),
                    leftTable: document.getElementById('leftTable'),
                    rightTable: document.getElementById('rightTable'),
                    belt: document.getElementById('servingBelt'),
                    startOverlay: document.getElementById('startOverlay'),
                    gameOverOverlay: document.getElementById('gameOverOverlay'),
                    finalScore: document.getElementById('finalScore'),
                    nickname: document.getElementById('nickname'),
                    leaderboard: document.getElementById('leaderboardList'),
                    recordSection: document.getElementById('recordSection')
                };
            }

            bindEvents() {
                document.getElementById('btnStart').onclick = () => this.start();
                document.getElementById('btnRestart').onclick = () => this.start();
                document.getElementById('btnSubmit').onclick = () => this.submitScore();
                this.el.leftTable.onclick = () => this.handleServe('left');
                this.el.rightTable.onclick = () => this.handleServe('right');

                window.onkeydown = (e) => {
                    if (e.key === 'ArrowLeft') this.handleServe('left');
                    if (e.key === 'ArrowRight') this.handleServe('right');
                };
            }

            start() {
                this.state.reset();
                this.el.startOverlay.style.display = 'none';
                this.el.gameOverOverlay.style.display = 'none';
                this.el.recordSection.style.display = 'block';
                this.el.container.classList.remove('fever-mode');

                this.setupInitialTables();
                this.fillQueue();
                this.updateUI();

                if (this.timer) clearInterval(this.timer);
                this.timer = setInterval(() => this.tick(), CONFIG.TIME.TICK);
                this.state.isActive = true;
            }

            setupInitialTables() {
                const shuffled = [...CONFIG.ANIMALS].sort(() => Math.random() - 0.5);
                this.state.tables.left = [shuffled[0]];
                this.state.tables.right = [shuffled[1]];
                this.renderTables();
            }

            renderTables() {
                const createHTML = (a) => `<div class="animal-slot">${a.emoji}<span class="food-hint">${a.food}</span></div>`;
                this.el.leftTable.innerHTML = this.state.tables.left.map(createHTML).join('');
                this.el.rightTable.innerHTML = this.state.tables.right.map(createHTML).join('');
            }

            fillQueue() {
                const currentFoods = [...this.state.tables.left, ...this.state.tables.right].map(a => a.food);
                while (this.state.foodQueue.length < CONFIG.MAX_QUEUE) {
                    let food;
                    if (this.state.isFever) {
                        food = Math.random() < CONFIG.FEVER.PROBABILITY ? this.state.feverFood : this.getRandom(currentFoods);
                    } else {
                        food = this.getRandom(currentFoods);
                    }
                    this.state.foodQueue.push(food);
                }
                this.renderQueue();
            }

            renderQueue() {
                this.el.belt.innerHTML = this.state.foodQueue.map((food, idx) =>
                    `<div class="food-item ${idx === 0 ? 'next' : ''}">${food}</div>`
                ).join('');
            }

            handleServe(side) {
                if (!this.state.isActive) return;

                const servedFood = this.state.foodQueue[0];
                const targetTable = this.state.tables[side];
                const tableDOM = side === 'left' ? this.el.leftTable : this.el.rightTable;

                const animalIdx = targetTable.findIndex(a => a.food === servedFood);

                if (animalIdx !== -1) {
                    this.onSuccess(tableDOM, animalIdx);
                } else {
                    this.onFailure(tableDOM);
                }

                this.state.foodQueue.shift();
                this.checkDifficulty();
                this.fillQueue();
                this.updateUI();
            }

            onSuccess(tableDOM, idx) {
                this.state.combo++;
                const bonus = Math.floor(this.state.combo / CONFIG.SCORING.COMBO_STEP) * CONFIG.SCORING.COMBO_BONUS;
                this.state.score += (CONFIG.SCORING.BASE + bonus);
                this.state.timeLeft = Math.min(CONFIG.TIME.LIMIT, this.state.timeLeft + CONFIG.TIME.BONUS);

                this.triggerEffect(tableDOM, 'success-fx');
                this.triggerHeart(tableDOM.querySelectorAll('.animal-slot')[idx]);

                if (this.state.combo >= CONFIG.FEVER.THRESHOLD && !this.state.isFever) {
                    this.startFever();
                }
            }

            onFailure(tableDOM) {
                this.state.combo = 0;
                this.state.score = Math.max(0, this.state.score - CONFIG.SCORING.FAIL_PENALTY);
                this.state.timeLeft -= CONFIG.TIME.PENALTY;

                this.triggerEffect(tableDOM, 'shake-fx');
                this.showFloatingText(`-${CONFIG.TIME.PENALTY}s`, 'var(--warning-color)');
                if (this.state.isFever) this.endFever();
            }

            /** FEVER SYSTEM */
            startFever() {
                this.state.isFever = true;
                this.state.feverTimer = CONFIG.FEVER.DURATION;
                const currentFoods = [...this.state.tables.left, ...this.state.tables.right].map(a => a.food);
                this.state.feverFood = this.getRandom(currentFoods);

                this.state.foodQueue = this.state.foodQueue.slice(0, 4); // í˜„ì¬ ë³´ì„ë˜ëŠ” ê²ƒë§Œ ë‚¨ê¹€
                this.el.container.classList.add('fever-mode');
                this.showFloatingText("ğŸ”¥ FEVER TIME! ğŸ”¥", "orange");
            }

            endFever() {
                this.state.isFever = false;
                this.el.container.classList.remove('fever-mode');
                this.showFloatingText("FEVER END", "#666");
            }

            /** ENGINE CORE */
            tick() {
                if (!this.state.isActive) return;

                this.state.timeLeft -= 0.1;
                if (this.state.isFever) {
                    this.state.feverTimer--;
                    if (this.state.feverTimer <= 0) this.endFever();
                }

                if (this.state.timeLeft <= 0) this.endGame();
                this.updateUI();
            }

            updateUI() {
                this.el.score.innerText = this.state.score;
                this.el.combo.innerText = this.state.combo;
                this.el.time.innerText = Math.max(0, this.state.timeLeft).toFixed(1);

                const percent = (this.state.timeLeft / CONFIG.TIME.LIMIT) * 100;
                this.el.timerBar.style.width = `${percent}%`;
                this.el.timerBar.classList.toggle('warning', percent < 30);
            }

            checkDifficulty() {
                const total = this.state.tables.left.length + this.state.tables.right.length;
                const level = CONFIG.DIFFICULTY.find(d => this.state.score > d.score && total === d.totalAnimals);

                if (level) {
                    const currentIds = [...this.state.tables.left, ...this.state.tables.right].map(a => a.id);
                    const nextAnimal = CONFIG.ANIMALS.find(a => !currentIds.includes(a.id));
                    if (nextAnimal) {
                        const side = this.state.tables.left.length <= this.state.tables.right.length ? 'left' : 'right';
                        this.state.tables[side].push(nextAnimal);
                        this.renderTables();
                    }
                }
            }

            endGame() {
                this.state.isActive = false;
                clearInterval(this.timer);
                this.el.finalScore.innerText = this.state.score;
                this.el.gameOverOverlay.style.display = 'flex';
                this.loadLeaderboard();
            }

            /** FX UTILS */
            triggerEffect(el, className) {
                el.classList.add(className);
                setTimeout(() => el.classList.remove(className), 300);
            }

            triggerHeart(parent) {
                if (!parent) return;
                const heart = document.createElement('div');
                heart.className = 'heart-fx';
                heart.innerText = 'â¤ï¸';
                parent.appendChild(heart);
                setTimeout(() => heart.remove(), 800);
            }

            showFloatingText(text, color) {
                const el = document.createElement('div');
                el.className = 'floating-text';
                el.innerText = text;
                el.style.cssText = `color: ${color}; left: 50%; top: 20%;`;
                this.el.container.appendChild(el);
                setTimeout(() => el.remove(), 800);
            }

            getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

            /** DATA API */
            async submitScore() {
                const nick = this.el.nickname.value;
                if (!nick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!");

                // ë²„íŠ¼ ë¹„í™œì„±í™”
                const btn = document.getElementById('btnSubmit');
                btn.disabled = true;
                btn.innerText = "ë“±ë¡ ì¤‘...";

                const body = new URLSearchParams({ [CONFIG.API.ENTRY_NICK]: nick, [CONFIG.API.ENTRY_SCORE]: this.state.score });

                try {
                    await fetch(CONFIG.API.FORM_URL, { method: 'POST', mode: 'no-cors', body });
                    alert("ë“±ë¡ ì„±ê³µ!");
                    this.el.recordSection.style.display = 'none';
                    this.loadLeaderboard(); // ì´ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•¨
                } catch (e) { console.error(e); }
            }

            // ìˆ˜ì •ëœ ë¶€ë¶„: function í‚¤ì›Œë“œë¥¼ ì œê±°í–ˆìŠµë‹ˆë‹¤.
            async loadLeaderboard() {
                this.el.leaderboard.innerHTML = "ë°ì´í„° ë¡œë”© ì¤‘...";
                try {
                    const res = await fetch(`${CONFIG.API.SHEET_URL}&t=${Date.now()}`);
                    const csv = await res.text();

                    const rows = csv.split('\n').slice(1);
                    const list = rows.map(row => {
                        const columns = row.replace(/["\r]/g, '').split(',');
                        if (columns.length < 3) return null;
                        return {
                            nick: columns[1],
                            score: parseInt(columns[2])
                        };
                    })
                        .filter(item => item && !isNaN(item.score))
                        .sort((a, b) => b.score - a.score)
                        .slice(0, 10);

                    this.renderLeaderboardUI(list);
                } catch (e) {
                    this.el.leaderboard.innerHTML = "ê¸°ë¡ ë¡œë”© ì‹¤íŒ¨";
                }
            }

            renderLeaderboardUI(list) {
                if (list.length === 0) {
                    this.el.leaderboard.innerHTML = "ì˜¤ëŠ˜ì˜ ì²« ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!";
                    return;
                }
                let html = '<table style="width:100%; border-collapse:collapse;">';
                list.forEach((item, i) => {
                    html += `<tr style="border-bottom:1px solid #555">
                <td style="padding:5px; color:${i < 3 ? '#ffd700' : '#ccc'}">${i + 1}ìœ„</td>
                <td style="text-align:left">${item.nick}</td>
                <td style="text-align:right; font-weight:bold">${item.score.toLocaleString()}</td>
            </tr>`;
                });
                this.el.leaderboard.innerHTML = html + '</table>';
            }
        }

        // ê²Œì„ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        const game = new ServingGame();
    </script>
</body>

</html>
