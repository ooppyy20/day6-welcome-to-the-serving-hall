<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>:: ì›°ì»´ íˆ¬ ë” ì„œë¹™í™€ ::</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        :root {
            --bg-color: #f0e68c;
            --primary-color: #ff6b6b;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #222;
            font-family: 'Pretendard', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #game-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 600px;
            max-height: 900px;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            text-align: center;
        }

        button {
            padding: 15px 40px;
            font-size: 20px;
            border: none;
            border-radius: 30px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            margin-top: 20px;
        }

        input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            margin-top: 10px;
            width: 60%;
            text-align: center;
        }

        #leaderboard {
            margin-top: 20px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            width: 80%;
            max-height: 300px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        td {
            padding: 5px;
            border-bottom: 1px solid #444;
        }
    </style>
</head>

<body>

    <div id="game-wrapper">
        <div id="game-container"></div>

        <div id="gameOverOverlay" class="overlay" style="display: none;">
            <h1>ì˜ì—… ì¢…ë£Œ!</h1>
            <p>ìµœì¢… ì ìˆ˜: <span id="finalScoreText">0</span></p>
            <div id="recordSection">
                <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" maxlength="10">
                <button id="btnSubmit">ì ìˆ˜ ë“±ë¡</button>
            </div>
            <div id="leaderboard">
                <h3>ì˜¤ëŠ˜ì˜ ê³ ë“ì ì</h3>
                <div id="leaderboardList">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
            <button onclick="location.reload()">ë‹¤ì‹œ ì˜¤í”ˆí•˜ê¸°</button>
        </div>
    </div>

    <script type="text/javascript">
        // 1. CONFIGURATION (Vanilla ë²„ì „ì˜ ë°¸ëŸ°ìŠ¤ ë°ì´í„° ì™„ë²½ ì´ì‹)
        const CONFIG = {
            ANIMALS: [
                { id: 'bear', emoji: 'ğŸ»', food: 'ğŸ²' },
                { id: 'fox', emoji: 'ğŸ¦Š', food: 'â˜•' },
                { id: 'rabbit', emoji: 'ğŸ°', food: 'ğŸ¥£' },
                { id: 'dog', emoji: 'ğŸ¶', food: 'ğŸ§ƒ' }
            ],
            TIME: { LIMIT: 30, PENALTY: 2, BONUS: 0.2 },
            SCORING: { BASE: 100, COMBO_STEP: 5, COMBO_BONUS: 20, FAIL_PENALTY: 50 },
            FEVER: { THRESHOLD: 10, DURATION: 5000, PROBABILITY: 0.8 },
            DIFFICULTY: [
                { score: 2000, totalAnimals: 2 },
                { score: 5000, totalAnimals: 3 }
            ],
            API: {
                FORM_URL: "https://docs.google.com/forms/d/e/1FAIpQLSedkgqcVKUXZbW64qAon3xzAnMDeECvHScQO4yEEEgWltlIIQ/formResponse",
                SHEET_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTS1t7Q4XpK2ISwW7yuy2R4GzDVvY9PaHaOW-yOAodVixvfPn14MUdsUYyg6INGxz-n5dh68HpCqzvr/pub?output=csv",
                ENTRY_NICK: "entry.1963889324",
                ENTRY_SCORE: "entry.1300941228"
            }
        };

        class GameScene extends Phaser.Scene {
            constructor() { super('GameScene'); }

            create() {
                // ìƒíƒœ ì´ˆê¸°í™”
                this.score = 0;
                this.combo = 0;
                this.timeLeft = CONFIG.TIME.LIMIT;
                this.isActive = true;
                this.isFever = false;
                this.feverTimerEvent = null; // í”¼ë²„ íƒ€ì´ë¨¸ ê´€ë¦¬ìš©
                this.foodQueue = [];

                const { width, height } = this.scale;
                this.add.rectangle(width / 2, height / 2, width, height, 0xf0e68c);

                // UI í…ìŠ¤íŠ¸
                this.scoreText = this.add.text(width / 2, 50, 'SCORE: 0', { fontSize: '40px', color: '#ff6b6b', fontWeight: 'bold' }).setOrigin(0.5);
                this.comboText = this.add.text(width / 2, 90, 'COMBO: 0', { fontSize: '20px', color: '#666' }).setOrigin(0.5);
                this.timerBarBg = this.add.rectangle(width / 2, 130, width * 0.8, 20, 0xdddddd);
                this.timerBar = this.add.rectangle(width / 2, 130, width * 0.8, 20, 0x2ed573);

                // êµ¬ì—­ ì„¤ì •
                this.leftZone = this.add.container(width * 0.25, height * 0.4);
                this.rightZone = this.add.container(width * 0.75, height * 0.4);

                const shuffled = [...CONFIG.ANIMALS].sort(() => Math.random() - 0.5);
                this.stateAnimals = { left: [shuffled[0]], right: [shuffled[1]] };

                this.renderTables();
                this.fillQueue();

                // ì…ë ¥ ì´ë²¤íŠ¸
                this.input.on('pointerdown', (p) => {
                    if (!this.isActive) return;
                    this.handleServe(p.x < width / 2 ? 'left' : 'right');
                });
                this.input.keyboard.on('keydown-LEFT', () => this.handleServe('left'));
                this.input.keyboard.on('keydown-RIGHT', () => this.handleServe('right'));
            }

            renderTables() {
                [this.leftZone, this.rightZone].forEach(z => z.removeAll(true));
                const draw = (zone, animals) => {
                    animals.forEach((a, i) => {
                        const y = i * 130;
                        zone.add(this.add.text(0, y, a.emoji, { fontSize: '80px' }).setOrigin(0.5));
                        zone.add(this.add.text(40, y + 30, a.food, { fontSize: '25px', backgroundColor: '#fff', padding: 5 }).setOrigin(0.5));
                    });
                };
                draw(this.leftZone, this.stateAnimals.left);
                draw(this.rightZone, this.stateAnimals.right);
            }

            fillQueue() {
                const currentFoods = [...this.stateAnimals.left, ...this.stateAnimals.right].map(a => a.food);

                while (this.foodQueue.length < 6) {
                    let type;
                    if (this.isFever && this.feverFood) {
                        type = Math.random() < CONFIG.FEVER.PROBABILITY ? this.feverFood : currentFoods[Math.floor(Math.random() * currentFoods.length)];
                    } else {
                        type = currentFoods[Math.floor(Math.random() * currentFoods.length)];
                    }

                    const obj = this.add.text(this.scale.width / 2, 750 - (this.foodQueue.length * 90), type, { fontSize: '60px' }).setOrigin(0.5);
                    this.foodQueue.push({ type, obj });
                }
            }

            handleServe(side) {
                if (!this.isActive) return;
                const served = this.foodQueue[0];
                const isCorrect = this.stateAnimals[side].some(a => a.food === served.type);

                if (isCorrect) {
                    this.onSuccess(side);
                } else {
                    this.onFailure();
                }

                // í ì—…ë°ì´íŠ¸ ì• ë‹ˆë©”ì´ì…˜
                served.obj.destroy();
                this.foodQueue.shift();
                this.foodQueue.forEach((f, i) => this.tweens.add({ targets: f.obj, y: 750 - (i * 90), duration: 100 }));

                this.checkDifficulty();
                this.fillQueue();
            }

            onSuccess(side) {
                this.combo++;
                const bonus = Math.floor(this.combo / CONFIG.SCORING.COMBO_STEP) * CONFIG.SCORING.COMBO_BONUS;
                this.score += (CONFIG.SCORING.BASE + bonus);
                this.timeLeft = Math.min(CONFIG.TIME.LIMIT, this.timeLeft + CONFIG.TIME.BONUS);

                this.scoreText.setText(`SCORE: ${this.score}`);
                this.comboText.setText(`COMBO: ${this.combo}`);
                this.cameras.main.flash(100, 100, 255, 100);

                if (this.combo >= CONFIG.FEVER.THRESHOLD && !this.isFever) {
                    this.startFever();
                }
            }

            onFailure() {
                this.combo = 0;
                this.score = Math.max(0, this.score - CONFIG.SCORING.FAIL_PENALTY);
                this.timeLeft -= CONFIG.TIME.PENALTY;

                this.scoreText.setText(`SCORE: ${this.score}`);
                this.comboText.setText(`COMBO: ${this.combo}`);
                this.cameras.main.shake(200, 0.02);

                if (this.isFever) this.endFever();
            }

            startFever() {
                this.isFever = true;
                const currentFoods = [...this.stateAnimals.left, ...this.stateAnimals.right].map(a => a.food);
                this.feverFood = currentFoods[Math.floor(Math.random() * currentFoods.length)];

                this.cameras.main.setBackgroundColor('#ffd700');

                // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆë‹¤ë©´ ì œê±° (ì¤‘ì²© ë°©ì§€)
                if (this.feverTimerEvent) this.feverTimerEvent.remove();

                this.feverTimerEvent = this.time.delayedCall(CONFIG.FEVER.DURATION, () => {
                    this.endFever();
                });
            }

            endFever() {
                this.isFever = false;
                this.feverFood = null;
                this.cameras.main.setBackgroundColor('#f0e68c');
                if (this.feverTimerEvent) {
                    this.feverTimerEvent.remove();
                    this.feverTimerEvent = null;
                }
            }

            checkDifficulty() {
                const total = this.stateAnimals.left.length + this.stateAnimals.right.length;
                const level = CONFIG.DIFFICULTY.find(d => this.score > d.score && total === d.totalAnimals);

                if (level) {
                    const currentIds = [...this.stateAnimals.left, ...this.stateAnimals.right].map(a => a.id);
                    const nextAnimal = CONFIG.ANIMALS.find(a => !currentIds.includes(a.id));
                    if (nextAnimal) {
                        const side = this.stateAnimals.left.length <= this.stateAnimals.right.length ? 'left' : 'right';
                        this.stateAnimals[side].push(nextAnimal);
                        this.renderTables();
                    }
                }
            }

            update(time, delta) {
                if (!this.isActive) return;
                this.timeLeft -= delta / 1000;

                // íƒ€ì´ë¨¸ ë°” ì—…ë°ì´íŠ¸
                const percent = Math.max(0, this.timeLeft / CONFIG.TIME.LIMIT);
                this.timerBar.width = (this.scale.width * 0.8) * percent;

                // ì‹œê°„ ë¶€ì¡± ê²½ê³  (ë¹¨ê°„ìƒ‰)
                if (percent < 0.3) this.timerBar.setFillStyle(0xf44336);
                else this.timerBar.setFillStyle(0x2ed573);

                if (this.timeLeft <= 0) {
                    this.isActive = false;
                    showGameOver(this.score);
                }
            }
        }

        // Phaser ì—”ì§„ ì‹¤í–‰
        const game = new Phaser.Game({
            type: Phaser.AUTO,
            parent: 'game-container',
            width: 600, height: 900,
            scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
            scene: [GameScene]
        });

        // --- UI ë° ë¦¬ë”ë³´ë“œ ë¡œì§ ---
        function showGameOver(score) {
            document.getElementById('gameOverOverlay').style.display = 'flex';
            document.getElementById('finalScoreText').innerText = score.toLocaleString();
            loadLeaderboard();
        }

        document.getElementById('btnSubmit').onclick = async () => {
            const nick = document.getElementById('nicknameInput').value;
            const score = document.getElementById('finalScoreText').innerText.replace(/,/g, '');
            if (!nick) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!");

            const btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.innerText = "ë“±ë¡ ì¤‘...";

            const body = new URLSearchParams({ [CONFIG.API.ENTRY_NICK]: nick, [CONFIG.API.ENTRY_SCORE]: score });
            try {
                await fetch(CONFIG.API.FORM_URL, { method: 'POST', mode: 'no-cors', body });
                alert("ë“±ë¡ ì™„ë£Œ!");
                document.getElementById('recordSection').style.display = 'none';
                loadLeaderboard();
            } catch (e) { alert("ë“±ë¡ ì‹¤íŒ¨"); btn.disabled = false; }
        };

        async function loadLeaderboard() {
            const listEl = document.getElementById('leaderboardList');
            try {
                const res = await fetch(`${CONFIG.API.SHEET_URL}&t=${Date.now()}`);
                const csv = await res.text();

                const rows = csv.split('\n').slice(1).map(row => {
                    const columns = row.trim().replace(/["\r]/g, '').split(',');
                    if (columns.length < 3) return null;
                    return { nick: columns[1], score: parseInt(columns[2]) };
                }).filter(r => r && r.nick && !isNaN(r.score))
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 10);

                if (rows.length > 0) {
                    // index1.htmlì˜ ë””ìì¸ ìŠ¤íƒ€ì¼ì„ ê·¸ëŒ€ë¡œ ì´ì‹
                    let html = '<table style="width:100%; border-collapse:collapse; color:white;">';
                    rows.forEach((r, i) => {
                        const rankColor = i < 3 ? '#ffd700' : '#ccc'; // 1-3ìœ„ ê°•ì¡° ìƒ‰ìƒ
                        html += `
                <tr style="border-bottom:1px solid #555">
                    <td style="padding:8px 5px; color:${rankColor}; font-weight:bold; width:20%;">${i + 1}ìœ„</td>
                    <td style="text-align:left; padding:8px 5px;">${r.nick}</td>
                    <td style="text-align:right; padding:8px 5px; font-weight:bold;">${r.score.toLocaleString()}</td>
                </tr>`;
                    });
                    listEl.innerHTML = html + '</table>';
                } else {
                    listEl.innerHTML = "ì˜¤ëŠ˜ì˜ ì²« ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!";
                }
            } catch (e) {
                console.error("Leaderboard Error:", e);
                listEl.innerHTML = "ê¸°ë¡ ë¡œë”© ì‹¤íŒ¨";
            }
        }
    </script>
</body>

</html>
